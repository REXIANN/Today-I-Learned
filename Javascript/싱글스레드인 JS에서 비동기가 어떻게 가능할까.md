# 싱글스레드인 JS에서 비동기가 어떻게 가능할까?

출처: 공부
태그: 브라우저

자바스크립트는 싱글 스레드 기반으로 동작하는 언어가 맞다. 그렇기에 멀티스레드에서 필연적으로 나오는 동시성 문제를 해결할 필요가 없다. 구글 크롬마저도 동시성 문제 때문에 자바스크립트 코드를 동시에 실행하지 못하게 한다. 속도와 안정성 이라는 싱글스레드의 강력한 이점을 채택한 것이다.

그렇기에 코드 실행 중 어딘가에서 걸리면 다음으로 진행할 수 없다. 대표적인 예로 `alert` 가 있는데, 경고창이 뜨면 확인을 누르기 전까지는 다음 코드로 넘어가지 않는다. 그래서 공부할때 `alert` 메서드를 절대 현업에 사용하지 말라는 글을 많이 봤었다. 심지어 MDN의 이벤트 루프 항목에서도 가급적 사용하지 말라고 한다.

다른 언어의 경우 함수를 하나의 스레드가 실행시키다가 다른 스레드의 다른 코드를 동작시키기 위해 해당 함수 관련 처리를 멈출 수 있다고 한다. 그러나 자바스크립트는 함수가 실행되면 해당 함수가 종료될 떄 까지 다른 코드를 실행할 수 없다.

### 그럼 어떻게 비동기 작업을 처리하지?

중요한 점은 자바스크립트 자체는 싱글 스레드가 맞다는 점이다. 웹이나 노드로 개발을 하는 과정에서는 순수하게 자바스크립트만을 실행하지 않는다. 정확하게는 V8 엔진만을 실행하는 일은 없다. 

비동기 작업의 경우 해당 작업은 브라우저에 내장된 WebAPI 에게 넘겨진다. 그 안에서 타이머, 네트워크 통신, 인터벌, 이벤트 등을 처리하고, 코드가 실행될 준비가 되면 태스크 큐에 해당 작업을 넣어준다. 그래서 사실상 비동기 함수가 동기적인 함수들과 ‘동시'에 동작하는 것 처럼 보이는 것이다.

node 에서 개발 시 기본적으로는 하나의 스레드에서만 돌아간다. 그러나 요즘처럼 멀티코어가 제공되는 하드웨어에서 동작한다면 여러 코어를 사용하여 최적화 시키거나 로드 밸런싱을 적용할 수 있다. 그러기 위해서는 워커 스레드나 클러스터링 작업이 필요하다고 한다. 성능의 경우 CPU intensive 한 작업은 java 가 노드에 비해 빠르다고 한다.

비동기 작업이 호출되면 이는 브라우저 API(Web API라고 많이 부른다)에게 넘겨진다. 이러한 API 들은 브라우저에 내장되어 있다. 콜 스택에서 받은 명령에 따라 API는 독자적인 싱글스레드 동작을 실행한다.

예를 들어 `setTimeout` 이 콜 스택에서 실행되면 이 작업은 상응하는 API로 보내진다. 여기서 상응하는 API란 지정된 시간을 대기하고, 이후 콜백 함수가 실행될 수 있도록 만드는 작업을 가진 API를 말한다. 

사실 이벤트 루프란 프로그래밍 패턴을 의미한다. 이 패턴은 완료된 이벤트의 결과를 처리하는 반복적인 루프이다. 자바스크립트 어플리케이션이 동작할 때 다양한 이벤트들을 실행하고, 이러한 이벤트들로 인해 이벤트에 상응하는 이벤트 핸들러가 처리를 위해 대기열에 추가된다. 이벤트 루프는 지속적으로 큐(여기서는 태스크 큐가 된다)를 지켜보다가(watch) 결과값이 나와서 큐에 있는 이벤트들을 처리한다.

이벤트 루프는 V8 엔진을 포함하는 개념이다. 이벤트 루프는 태스크 큐를 가지고 있으며, 만일 태스크가 자바스크립트를 실행해야 하는 일인 경우(처음 프로그램을 실행하면 자바스크립트 코드를 읽어서 실행하라 - 라는 명령을 받으므로) V8과 같은 자바스크립트 엔진을 가져다 사용한다.

### V8 엔진 안에는 무엇이 있나?

자바스크립트를 해석하는 엔진인 만큼 자바스크립트 실행을 위한 것들이 존재한다고 보면 된다.

- 콜스택
- Execution context(실행 컨텍스트)
- 힙과 가비지 컬렉션
- 메모리 할당 기능(자바스크립트 오브젝트들을 위해)

v8엔진에 없는 것들은 다음과 같다

- event loop (당연하게도)
- 태스크 큐 (다른 이름으로는 마이크로 태스크 큐)
- Web APIs - setTimeout, fetch, DOM 조작 등 .. 전부 자바스크립트 안에서 부를 수 있지만 실행은 V8 엔진 외부에서 다른 언어로 브라우저에서 (또는 노드에서) 실행된다. Web APIs 는 단지 연결 통로라고 볼 수 있다. 2020년 12월 기준으로 setTimeout 과 같은 몇몇 api 는 V8 자체에서 지원하기 시작했다고 하니 참고하자.

### stackoverflow 에서 찾은 QnA

[Relationship between event loop,libuv and v8 engine](https://stackoverflow.com/questions/49811043/relationship-between-event-loop-libuv-and-v8-engine)

1. 이벤트 루프는 v8이나 libuv의 일부인가?
2. 이벤트 큐는 이벤트 루프의 일부인가? 이벤트 큐는 libuv 또는 v8 엔진 또는 이벤트 루프 자체에 의해 생성되는가?
3. libuv와 v8의 공통점(연결점)은 무엇인가?
4. 이벤트 루프가 싱글 스레드 기반이라면, libuv 가 파일 IO 를 위해 멀티스레드를 생성하는가?
5. 브라우저가 이벤트 루프 메커니즘을 가지고 있는가? 아니면 노드만 가지고 있는가?

1. 이벤트루프는 무엇보다도 자바스크립트 프로그래밍 모델의 기본이 되는 상위 수준(high-level)의 개념이다. 실제로 모든 V8 임베더(?)는 이벤트 루프를 구현해야 한다. V8 은 임베더가 대체하거나 확장할 수 있는 기본적인 구현을 제공한다.
2. 질문을 이해하지 못함.
3. 없다. 그러나 노드는 두개 다 사용한다.
4. 그렇다. 이벤트 루프는 싱글스레드 이다.
5. 그렇다. 브라우저도 가지고 있다.