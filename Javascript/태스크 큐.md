# 태스크 큐

출처: 공부
태그: 브라우저, 자바스크립트

자바스크립트는 싱글 스레드 기반 언어이고, 자바스크립트 엔진은 하나의 호출 스택만을 사용한다. 이는 요청이 동기적으로 처리되어, 한번에 한 가지 일만 처리할 수 있음을 의미한다.

싱글 스레드 언어에서의 비동기요청은 비동기 콜백을 사용함으로써 해결된다. 비동기 요청은 자바스크립트 엔진을 구동하는 환경인 브라우저나 nodejs 에서 처리된다.

자바스크립트 엔진은 힙 영역에 객체들을 할당한다. 그리고 엔진은 크기가 동적으로 변하는 값들의 참조값을 가지고 있다. 

함수가 호출될 때 실행 컨텍스트가 생성되며, 이러한 실행 컨텍스트들이 콜 스택을 구현한다. 새로운 함수를 만나면 새로운 실행 컨텍스트가 생성되며, 기존의 컨텍스트와 체인(스코프 체인) 으로 연결하고 this 와 값들에 대한 정보를 가져온다.

이벤트 루프는 콜스택을 바라보다가 콜스택이 빈다면 이벤트 큐에 있는 작업들을 하나씩 꺼내어 실행한다. 이벤트 루프는 하나 이상의 태스크 큐를 가진다. 태스크 큐는 태스크의 Set 이다.

이벤트 루프는 큐의 첫번째 태스크를 가져오는 것이 아니라, 태스크 큐에서 실행 가능한(runnable) 첫번째 태스크를 가져온다. 다시 말해 태스크 중에서 가장 오래된 태스크를 가져온다.

이벤트루프는 브라우저와 노드에서 공통으로 제공한다. 자바스크립트는 싱글 스레드 기반의 언어이지만, 자바스크립트가 구동되는 환경(노드, 브라우저)은 여러 스레드가 사용된다. 여러 스레드가 사용되는 구동환경이 자바스크립트 엔진과 연동하기 위해 사용되는 장치가 바로 ‘이벤트루프' 인 것이다.

이벤트 루프는 크게 세가지 종류가 있다.

1. window event loop -> 같은 origin 인 모든 윈도우는 윈도우 이벤트 루프를 공유한다. 또한 모든 윈도우들은 동기적으로 소통할 수 있게 된다.

2. worker event loop -> window event loop 와는 독립적으로 실행된다.

3. worklet event loop -> 미상

## 태스크 큐 란?

태스크 큐는 구체적으로 마이크로 태스크 큐 와 매크로 태스크 큐로 나뉘어진다. 

마이크로 태스크들은 실행하면서 새로운 마이크로 태스크를 큐에 추가할 수도 있다. 새롭게 추가된 마이크로 태스크도 큐가 빌 때까지 계속해서 실행된다. 

반대로, 이벤트 루프는 매크로 태스크 큐에 있는 것을 실행시키기 시작할 때, 큐에 존재하는 매크로 태스크만을 실행한다. 매크로 태스크가 추가된 매크로 태스크는 다음 이벤트 루프가 실행될 때 까지 실행되지 않는다.

API 에 따라 마이크로 태스크 큐를 사용하거나 매크로 태스크 큐를 사용한다.

- macro tasks: requestAnimationFrame, I/O, UI rendering, setTimeout, setInterval, setImmediate
- micro tasks: process.nextTick, Promises, queueMicrotask(f), MutationObserver

이벤트루프는 다음을 반복한다.

1. 매크로 태스크 큐에서 가장 오래된 태스크를 꺼내서 실행시킨다.
2. 마이크로 태스크 큐에 있는 모든 태스크를 실행시킨다.
3. 렌더링 작업을 실행한다.
4. 매크로 태스크 큐에 새로운 매크로 태스크가 나타날 때 까지 대기한다.
5. 1번으로 돌아간다.